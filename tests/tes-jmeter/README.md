# TES JMeter

TES JMeter can be used to execute a stress test written in JMeter to test a running docker container.

## Assumptions of the stress test

The execution of the stress test assumes a number of files to be in place then JMeter is started.

| **File/Directory**                             | **Description**                                                                             |
|------------------------------------------------|---------------------------------------------------------------------------------------------|
| `/usr/local/bin/jmeter`                        | The location of the JMeter script that will execute JMeter                                  |
| `src/test/resources/stress-test.jmx`           | The JMeter plan with the stress test. The path is relative to the root of the Gradle module |
| `src/test/resources/user.properties`           | Defines properties to be loaded used JMeter                                                 |
| `src/test/resources/user-<profile>.properties` | Defines properties to be loaded used JMeter using a specific profile                        |

A profile can be defined by settings the system property: `stress.test.profile`. This property will hold the profile 
name to use to load the property file that will be parsed to JMeter.

If `stress.test.profile` is `local` when the property file at `src/test/resources/user-local.properties` will be used
with JMeter.

### Property file

The property file parsed to JMeter (`src/test/resources/user.properties` or `src/test/resources/user-<profile>.properties`)
can contain any property that is supported by JMeter.

The property `service.port` in the property file will be overwritten with the exported port of the docker container, so
JMeter can send a sample to the right `<host>` and `<port>`

### Docker container

The running docker container is assumed to expose port `8080` to some port. The executor will automatically
lookup the external port to port `8080`.

## The results

The execution will generate the following results:

| **File/Directory**                      | **Description**                                           |
|-----------------------------------------|-----------------------------------------------------------|
| `build/test-results`                    | The path to the result of the JMeter execution            |
| `build/test-results/jmeter/results.jtl` | The result file of all samples that is executed by JMeter |
| `build/test-results/jmeter/report-html` | The resulting HTML report generated by JMeter             |

## Unit tests

The executor can be used in a unit test like this:

```groovy
@Slf4j
class JMeterSpec extends Specification {

    void "Execute JMeter Test"() {
        given: 'Service is available'
            // GenericContainer<T> container = some GenericContainer...
            container.isHostAccessible()

        and: 'JMeter executor is prepared'
            JMeterExecutor executor = new JMeterExecutor()
            executor.prepareExecutor(container)

        when: 'Execute JMeter test'
            Boolean jMeterResult = executor.runTests()
            def statisticResults = new JsonSlurper().parse(JMeterExecutor.STATISTIC_RESULT_FILE)

        then: 'Verify stress test result'
            jMeterResult
            statisticResults.Total.errorPct == 0.0
    }

}
```
